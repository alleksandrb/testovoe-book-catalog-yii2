# Book Catalog - Yii2 Test Project

Каталог книг с авторами, подписками и SMS уведомлениями.

## Установка

1. Клонировать репозиторий и перейти в директорию проекта
```bash
git clone https://github.com/alleksandrb/testovoe-book-catalog-yii2.git
cd testovoe-book-catalog-yii2
```

2. Создать файл `.env` на основе примера:
```bash
cp .env.example .env
```

Отредактировать `.env` и указать SMS API ключ:
```env
# Database Configuration
DB_HOST=mysql
DB_PORT=3306
DB_NAME=book_catalog
DB_USER=root
DB_PASSWORD=root

# SMS Pilot Configuration
SMSPILOT_API_KEY=YOUR_API_KEY_HERE
SMSPILOT_API_URL=https://smspilot.ru/api.php
```

Для тестирования можно использовать ключ эмулятор от smspilot.ru (реальной отправки SMS не происходит).

3. Собрать и запустить Docker контейнеры:
```bash
make build
make up
```

4. Инициализировать приложение (миграции, RBAC, тестовые данные):
```bash
make init
```

5. Создать пользователя для входа в систему:
```bash
make user-create USER=admin PASS=admin
```

6. Открыть в браузере: http://localhost:8000

## Управление через Makefile

Проект использует Makefile для удобного управления. Доступные команды:

- `make build` - Собрать Docker образы
- `make up` - Запустить все контейнеры
- `make down` - Остановить все контейнеры
- `make restart` - Перезапустить все контейнеры
- `make logs` - Показать логи всех контейнеров
- `make shell` - Открыть shell в PHP контейнере
- `make init` - Инициализировать приложение (миграции, RBAC, seed)
- `make migrate` - Применить миграции БД
- `make rbac-init` - Инициализировать RBAC
- `make seed` - Заполнить БД тестовыми данными
- `make worker` - Запустить воркер очереди вручную
- `make user-create USER=admin PASS=admin` - Создать нового пользователя

Примеры использования:
```bash
# Полная инициализация проекта
make build && make up && make init

# Создание пользователя (обязательно после init)
make user-create USER=admin PASS=admin

# Просмотр логов
make logs

# Открыть консоль в контейнере
make shell
```

## Структура проекта

Проект реализован в слоистой архитектуре с применением SOLID принципов:

- `models/` - Модели данных (ActiveRecord)
- `repositories/` - Репозитории (слой доступа к данным, интерфейсы и реализации)
- `services/` - Сервисы (бизнес-логика, SOLID)
- `controllers/` - Контроллеры (HTTP слой)
- `components/` - Компоненты (SMS отправитель)
- `config/` - Конфигурация DI контейнера
- `migrations/` - Миграции БД

## Функциональность

### Роли пользователей

1. **Гость** (`?`) - может:
   - Просматривать книги и авторов
   - Подписываться на новые книги автора (с указанием телефона)
   - Просматривать отчеты

2. **Пользователь** (`@`) - может все что гость, плюс:
   - Добавлять, редактировать, удалять книги
   - Добавлять, редактировать, удалять авторов

### Основные функции

1. **Книги**:
   - Название, год выпуска, описание, ISBN, фото главной страницы
   - Связь многие-ко-многим с авторами

2. **Авторы**:
   - ФИО
   - Связь многие-ко-многим с книгами

3. **Подписки**:
   - Гости могут подписаться на новые книги автора
   - При добавлении новой книги автора, подписчикам отправляется SMS уведомление

4. **Отчеты**:
   - ТОП 10 авторов, выпустивших больше всего книг за указанный год
   - Доступен всем пользователям

## Очередь задач

Проект использует очередь задач для фоновой отправки SMS уведомлений подписчикам. При создании новой книги задачи отправки уведомлений добавляются в очередь и обрабатываются фоновым воркером.


## Архитектура

Слоистая архитектура:
1. **Presentation Layer** (Controllers, Views) - HTTP запросы/ответы
2. **Service Layer** - бизнес-логика
3. **Repository Layer** - доступ к данным
4. **Model Layer** - модели данных

## Тестирование SMS

Для тестирования SMS уведомлений можно использовать ключ эмулятор от smspilot.ru (реальной отправки SMS не происходит).
